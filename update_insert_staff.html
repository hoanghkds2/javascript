<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"/>
    <link rel="stylesheet" href="styles.css" />
    <title>Quản lý nhân viên</title>
  </head>
  <body>
    <div id="sticky-wrapper">
      <header class="site-navbar js-sticky-header site-navbar-target">
        <div class="container">
          <div class="row align-items-center position-relative">
            <div class="site-logo">
              <a href="index.html" class="text-black">
                <span class="text-primary">Quản lý nhân viên</span>
              </a>
            </div>
            <div class="col-12">
              <nav class="site-navigation text-right ml-auto">
                <ul class="site-menu main-menu js-clone-nav ml-auto d-none d-lg-block">
                  <li><a href="staffs.html" class="nav-link">Danh sách nhân viên</a></li>
                  <li><a href="departments.html" class="nav-link">Phòng ban</a></li>
                  <li><a href="staffSalary.html" class="nav-link">Bảng lương</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </header>
    </div>
    <div class="container">
      <div>
        <label>Họ và tên</label>
        <input type="text" id="name" />
      </div>
      <div>
        <label>Ngày sinh</label>
        <input type="datetime-local" id="doB" />
      </div>
      <div>
        <label>Ngày vào công ty</label>
        <input type="datetime-local" id="startDate" />
      </div>
      <div>
        <label>Phòng ban</label>
        <select id="department"></select>
      </div>
      <div>
        <label>Số ngày nghỉ còn lại</label>
        <input type="number" id="annualLeave" />
      </div>
      <div>
        <label>Số ngày làm việc thêm</label>
        <input type="number" id="overTime" />
      </div>
      <div>
        <label>Tỉ lệ lương</label>
        <input type="text" id="salaryScale" />
      </div>
      <div>
        <label>Ảnh đại diện</label>
        <input type="text" id="image" />
      </div>
      <button id="save" type="button" class="btn btn-primary">Lưu</button>
    </div>
    <script>
      let url = new URL(window.location.href);
      let staff_id = url.searchParams.get("staff_id");
      fetch("http://localhost:8082/departments")
        .then(function (response) {
          return response.json();
        })
        .then(function (departments) {
          var departmentSelect = document.getElementById("department");
          departments.forEach(function (e) {
            var option = document.createElement("option");
            option.value = e.id;
            option.textContent = e.name;
            departmentSelect.appendChild(option);
          });
          return departments;
        })
        .then(function (departments) {
          if (staff_id) {
            fetch("http://localhost:8082/staffs")
              .then(function (response) {
                return response.json();
              })
              .then(function (staffs) {
                var staff = staffs.find(function (x) {
                  return x.id == staff_id;
                });

                document.getElementById("name").value = staff.name;
                document.getElementById("doB").value = staff.doB;
                document.getElementById("startDate").value = staff.startDate;

                var departmentOption = document.querySelector(
                  `#department option[value="${staff.departmentId}"]`
                );
                if (departmentOption) {
                  departmentOption.selected = true;
                }

                document.getElementById("annualLeave").value =
                  staff.annualLeave;
                document.getElementById("overTime").value = staff.overTime;
                document.getElementById("salaryScale").value =
                  staff.salaryScale;
                document.getElementById("image").value = staff.image;
              });
          }
        });

      document.getElementById("save").addEventListener("click", function () {
        var name = document.getElementById("name").value;
        var doB = document.getElementById("doB").value;
        var startDate = document.getElementById("startDate").value;
        var department_id = document.getElementById("department").value;
        var annualLeave = document.getElementById("annualLeave").value;
        var overTime = document.getElementById("overTime").value;
        var salaryScale = document.getElementById("salaryScale").value;
        var image = document.getElementById("image").value;

        if (!staff_id) {
          fetch("http://localhost:8082/staffs", {
            method: "POST",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: name,
              doB: doB,
              startDate: startDate,
              departmentId: department_id,
              annualLeave: annualLeave,
              overTime: overTime,
              salaryScale: salaryScale,
              image: image,
            }),
          }).then(function (response) {
            window.location.href = "staffs.html";
          });
        } else {
          fetch("http://localhost:8082/staffs", {
            method: "PATCH",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: staff_id,
              name: name,
              doB: doB,
              startDate: startDate,
              departmentId: department_id,
              annualLeave: annualLeave,
              overTime: overTime,
              salaryScale: salaryScale,
              image: image,
            }),
          }).then(function (response) {
            response;
            window.location.href = "staffs.html";
          });
        }
      });
    </script>
  </body>
</html>
